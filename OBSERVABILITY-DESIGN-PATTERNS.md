# Observability Design Patterns

## Overview
This document outlines the observability design patterns implemented in the payment-api-instrumented service following OpenTelemetry semantic conventions and industry best practices.

**Note**: This service is distinct from `payment-api` (business KPI service). See `SERVICE-COMPARISON.md` for details.

## Resource Attributes

### Service Identification
- **service.name**: `payment-api-instrumented` - Unique service identifier
- **service.version**: `1.0.0` - Semantic versioning
- **service.namespace**: `ebanking.observability` - Logical grouping for observability demo services
- **service.instance.id**: Container hostname - Unique instance identifier

### Deployment Context
- **deployment.environment**: `production` - Environment name (dev/staging/production)
- **deployment.environment.type**: `docker` - Deployment type
- **deployment.region**: `on-premise` - Geographic or logical region

### Host & Container Attributes
- **host.name**: Machine name from environment
- **host.id**: Unique host identifier
- **host.type**: `container` - Host type classification
- **container.name**: Container hostname
- **container.id**: Container identifier
- **container.runtime**: `docker` - Container runtime

### Infrastructure Attributes
- **cloud.platform**: `docker-compose` - Platform identifier
- **cloud.provider**: `on-premise` - Cloud provider or on-premise
- **cluster.name**: `observability-stack` - Cluster identifier

### Application Metadata
- **app.team**: `platform-engineering` - Owning team
- **app.owner**: `observability-team` - Service owner
- **app.tier**: `backend` - Application tier
- **app.type**: `instrumented-demo` - Application type
- **app.purpose**: `observability-testing` - Primary purpose

## Telemetry Signals

### 1. Traces (Distributed Tracing)
**Backend**: Grafana Tempo
**Protocol**: OTLP/gRPC on port 4317
**Endpoint**: `http://tempo:4317`

**Instrumentation**:
- ASP.NET Core automatic instrumentation
- HTTP client instrumentation
- SQL client instrumentation with statement capture
- Custom spans with enriched context

**Trace Enrichment**:
- HTTP request/response body sizes
- Exception recording enabled
- Custom tags for business context

### 2. Metrics
**Backend**: Prometheus
**Exporters**: 
- Prometheus scrape endpoint (`/metrics`)
- OTLP exporter to Tempo

**Metric Types**:
- **Runtime Metrics**: GC, memory, thread pool
- **Process Metrics**: CPU, memory usage
- **HTTP Metrics**: Request duration, status codes
- **Custom Business Metrics**: Payment processing metrics

**Tempo-Generated Metrics**:
- **Service Graphs**: Request rates, error rates, latencies between services
- **Span Metrics**: Detailed span-level metrics with custom dimensions

**Histogram Buckets**:
- Service graphs: `[0.1, 0.2, 0.4, 0.8, 1.6, 3.2, 6.4, 12.8]` seconds
- Span metrics: `[0.002, 0.004, ..., 16.384]` seconds (microsecond precision)

### 3. Logs
**Backend**: Grafana Loki (via Promtail)
**Format**: Structured JSON (Compact JSON Formatter)

**Log Enrichment**:
- Service name, version, namespace
- Environment name
- Machine/container name
- Container ID
- Host type
- Deployment environment
- Trace context (automatic correlation)

## Correlation Strategy

### Logs ↔ Traces
- Automatic trace context propagation via OpenTelemetry
- Trace ID and Span ID automatically added to logs
- Serilog enrichers capture trace context

### Traces ↔ Metrics
- Exemplars enabled in Prometheus remote write
- Span metrics generated by Tempo
- Service graphs show RED metrics (Rate, Errors, Duration)

### Metrics ↔ Logs
- Common labels: service.name, deployment.environment, host.name
- Time-based correlation via timestamps
- Container ID for precise correlation

## Query Patterns

### Find traces for instrumented service
```
{service.name="payment-api-instrumented"}
```

### Find traces with errors in production
```
{service.name="payment-api-instrumented" && deployment.environment="production" && status=error}
```

### Find logs for a specific trace
```
{ServiceName="payment-api-instrumented"} | json | trace_id="<trace-id>"
```

### Service graph metrics
```
traces_service_graph_request_total{client="payment-api-instrumented"}
traces_spanmetrics_latency_bucket{service_name="payment-api-instrumented"}
```

## Dimensions for Analysis

### Service Graphs
- deployment.environment
- service.namespace
- host.name
- container.name

### Span Metrics
- deployment.environment
- service.namespace
- http.method
- http.status_code
- host.name

## Best Practices Implemented

1. **Semantic Conventions**: Following OpenTelemetry semantic conventions for attribute naming
2. **Consistent Naming**: Uniform naming across all telemetry signals
3. **Resource Attributes**: Rich resource attributes for context
4. **Cardinality Control**: Limited high-cardinality dimensions
5. **Structured Logging**: JSON format for machine readability
6. **Trace Sampling**: Configurable sampling strategies
7. **Exemplars**: Linking metrics to traces
8. **Health Checks**: Dedicated health endpoint for monitoring
9. **Graceful Shutdown**: Proper cleanup of telemetry providers

## Environment Variables

All observability metadata can be configured via environment variables:

```yaml
SERVICE_NAME=payment-api-instrumented
SERVICE_VERSION=1.0.0
SERVICE_NAMESPACE=ebanking.observability
SERVICE_PURPOSE=observability-testing
DEPLOYMENT_ENVIRONMENT=production
DEPLOYMENT_REGION=on-premise
CLUSTER_NAME=observability-stack
CONTAINER_RUNTIME=docker
ORCHESTRATOR=docker-compose
```

## Monitoring Endpoints

- **Health**: `http://localhost:8888/health`
- **Metrics**: `http://localhost:8888/metrics` (Prometheus format)
- **Swagger**: `http://localhost:8888/swagger` (Development only)

## Visualization in Grafana

### Dashboards
1. **Service Overview**: RED metrics, service graphs
2. **Trace Analysis**: Latency distribution, error rates
3. **Resource Utilization**: CPU, memory, GC metrics
4. **Business Metrics**: Payment-specific KPIs

### Alerts
- High error rate (> 5%)
- High latency (P95 > 1s)
- Service unavailability
- Resource exhaustion

## Future Enhancements

1. **Baggage Propagation**: Pass business context across service boundaries
2. **Custom Samplers**: Intelligent sampling based on business rules
3. **Log Sampling**: Reduce log volume while maintaining visibility
4. **Distributed Context**: Propagate user/session context
5. **SLO Tracking**: Service Level Objectives and error budgets
